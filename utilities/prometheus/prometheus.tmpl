#!/usr/bin/env bash

cat << EOF > /etc/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 30s

  scrape_configs:
    - job_name: 'prometheus'
      scrape_interval: 5s
      static_configs:
        - targets: ['localhost:9090']
          
    - job_name: 'jenkins'
      metrics_path: /prometheus
      static_configs:
        - targets: ['primary.jenkins.${env}.local']

    - job_name: 'teleport'
      ec2_sd_configs:
        - region: us-east-1
          port: 3434
          filters:
            - name: tag:env
              values:
                - ${env}
    
    - job_name: 'nginx'
      ec2_sd_configs:
        - region: us-east-1
          port: 9113
          filters:
            - name: tag:env
              values:
                - ${env}
            - name: tag:app
              values:
                - ingress_nginx

    - job_name: 'node'
      ec2_sd_configs:
        - region: us-east-1
          port: 9100
          filters:
            - name: tag:env
              values:
                - ${env}
EOF

docker run -d --restart always \
    -v /etc/prometheus.yml:/etc/prometheus.yml \
    -p 9090:9090 \
    --name prometheus \
    prom/prometheus
